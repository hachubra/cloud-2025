# Домашнее задание к занятию «Безопасность в облачных провайдерах»  

Используя конфигурации, выполненные в рамках предыдущих домашних заданий, нужно добавить возможность шифрования бакета.

---
## Задание 1. Yandex Cloud   

1. С помощью ключа в KMS необходимо зашифровать содержимое бакета:

 - создать ключ в KMS;
 - с помощью ключа зашифровать содержимое бакета, созданного ранее.
2. (Выполняется не в Terraform)* Создать статический сайт в Object Storage c собственным публичным адресом и сделать доступным по HTTPS:

 - создать сертификат;
 - создать статическую страницу в Object Storage и применить сертификат HTTPS;
 - в качестве результата предоставить скриншот на страницу с сертификатом в заголовке (замочек).

Полезные документы:

- [Настройка HTTPS статичного сайта](https://cloud.yandex.ru/docs/storage/operations/hosting/certificate).
- [Object Storage bucket](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/storage_bucket).
- [KMS key](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/kms_symmetric_key).

#### Решение 1. 

Добавляем ключ и шифруем бакет: 

```bash
resource "yandex_kms_symmetric_key" "key-solovev" {
  name              = "key-s"
  description       = "homework-15.3-cloud"
  default_algorithm = "AES_128"
  rotation_period   = "8760h" // 1 год
}

resource "yandex_storage_bucket" "solovev_bucket" {
  bucket    = "mybucketsolovev1"
  folder_id = var.folder_id
  max_size   = 10485760
  anonymous_access_flags {
    read        = true
    list        = true
    config_read = true
  }
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        kms_master_key_id = yandex_kms_symmetric_key.key-solovev.id
        sse_algorithm     = "aws:kms"
      }
    }
  }  
}
```

После применения загруженный ранее файл не зашифрова. Для шифрования его необходимо перезалить.
Для удаления файла комментируем блок:

```bash
# resource "yandex_storage_object" "image_object" {
#   # access_key = yandex_iam_service_account_static_access_key.sa-static-key.access_key
#   # secret_key = yandex_iam_service_account_static_access_key.sa-static-key.secret_key
#   bucket     = "mybucketsolovev1"
#   key        = "my_image.png"
#   source     = "/home/alex/cloud-2025/img/1.png"
# }

```
Применяем:

```bash
alex@ubu04:~/cloud-2025/src-15-1$ terraform apply
```

```bash
# yandex_storage_object.image_object will be destroyed
  # (because yandex_storage_object.image_object is not in configuration)
  - resource "yandex_storage_object" "image_object" {
      - acl          = "private" -> null
      - bucket       = "mybucketsolovev1" -> null
      - content_type = "application/octet-stream" -> null
      - id           = "my_image.png" -> null
      - key          = "my_image.png" -> null
      - source       = "/home/alex/cloud-2025/img/1.png" -> null
      - tags         = {} -> null
    }

Plan: 0 to add, 0 to change, 1 to destroy.
```

Снова загружаемраскоментируя блок и применяя манифест:

```bash
resource "yandex_storage_object" "image_object" {
  # access_key = yandex_iam_service_account_static_access_key.sa-static-key.access_key
  # secret_key = yandex_iam_service_account_static_access_key.sa-static-key.secret_key
  bucket     = "mybucketsolovev1"
  key        = "my_image.png"
  source     = "/home/alex/cloud-2025/img/1.png"
}

```

```bash
alex@ubu04:~/cloud-2025/src-15-1$ terraform apply
```

```bash
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # yandex_storage_object.image_object will be created
  + resource "yandex_storage_object" "image_object" {
      + acl          = "private"
      + bucket       = "mybucketsolovev1"
      + content_type = (known after apply)
      + id           = (known after apply)
      + key          = "my_image.png"
      + source       = "/home/alex/cloud-2025/img/1.png"
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```
Убеждаемся, что файл зашифрован:

![Screen9](https://github.com/hachubra/cloud-2025/blob/main/img/9.png)

--- 
## Задание 2*. AWS (задание со звёздочкой)

Это необязательное задание. Его выполнение не влияет на получение зачёта по домашней работе.

**Что нужно сделать**

1. С помощью роли IAM записать файлы ЕС2 в S3-бакет:
 - создать роль в IAM для возможности записи в S3 бакет;
 - применить роль к ЕС2-инстансу;
 - с помощью bootstrap-скрипта записать в бакет файл веб-страницы.
2. Организация шифрования содержимого S3-бакета:

 - используя конфигурации, выполненные в домашнем задании из предыдущего занятия, добавить к созданному ранее бакету S3 возможность шифрования Server-Side, используя общий ключ;
 - включить шифрование SSE-S3 бакету S3 для шифрования всех вновь добавляемых объектов в этот бакет.

3. *Создание сертификата SSL и применение его к ALB:

 - создать сертификат с подтверждением по email;
 - сделать запись в Route53 на собственный поддомен, указав адрес LB;
 - применить к HTTPS-запросам на LB созданный ранее сертификат.

Resource Terraform:

- [IAM Role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role).
- [AWS KMS](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kms_key).
- [S3 encrypt with KMS key](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_object#encrypting-with-kms-key).

Пример bootstrap-скрипта:

```
#!/bin/bash
yum install httpd -y
service httpd start
chkconfig httpd on
cd /var/www/html
echo "<html><h1>My cool web-server</h1></html>" > index.html
aws s3 mb s3://mysuperbacketname2021
aws s3 cp index.html s3://mysuperbacketname2021
```

### Правила приёма работы

Домашняя работа оформляется в своём Git репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
Файл README.md должен содержать скриншоты вывода необходимых команд, а также скриншоты результатов.
Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
